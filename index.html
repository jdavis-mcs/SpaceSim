<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaceship Bridge Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --panel-bg: rgba(10, 20, 40, 0.8);
            --border-color: #2a9d8f;
            --text-cyan: #26c4da;
            --text-light: #e0f2f1;
            --disabled-bg: #4a5568;
            --alert-red: #e53e3e;
            --active-icon-bg: #2a9d8f;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: var(--text-light);
            overflow: hidden;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        #viewscreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .ui-container {
            display: grid;
            grid-template-areas:
                "header header"
                "nav main"
                "footer footer";
            grid-template-rows: auto 1fr auto;
            grid-template-columns: 60px 1fr;
            height: 100vh;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.2), rgba(0,0,0,0.6));
        }
        .station-nav button.active { background-color: var(--active-icon-bg); }
        .station-nav button { position: relative; transition: background-color 0.2s; }
        
        .station-nav button.has-notification::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            background-color: var(--alert-red);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        .view { display: none; }
        .view.active { display: block; }
        .progress-bar-bg { background-color: #2d3748; }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
        .hull-ok { background-color: #38a169; }
        .hull-warn { background-color: #d69e2e; }
        .hull-crit { background-color: #e53e3e; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #38b2ac; }
        
        .disabled-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 10;
        }
        .fullscreen-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body>
    <canvas id="viewscreen"></canvas>
    <div class="ui-container">
        <header style="grid-area: header;" class="p-2 flex justify-between items-center bg-black/50 border-b-2 border-[var(--border-color)]">
            <h1 class="text-2xl font-orbitron text-[var(--text-cyan)]">USS RESOLUTE</h1>
            <div id="mission-title-display" class="text-xl font-semibold text-amber-400">No Mission Loaded</div>
            <div class="flex items-center space-x-4">
                <span id="credits-display" class="text-lg">Credits: 0</span>
                <div class="w-48">
                    <div class="text-sm text-center">Hull Integrity</div>
                    <div class="progress-bar-bg rounded-full">
                        <div id="hull-bar" class="progress-bar-fill text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-full" style="width: 100%">100%</div>
                    </div>
                </div>
            </div>
        </header>

        <nav style="grid-area: nav;" class="station-nav flex flex-col items-center space-y-2 p-2 bg-black/50 border-r-2 border-[var(--border-color)]">
            <button data-view="comms" class="p-2 rounded-lg active w-full" title="Comms"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg></button>
            <button data-view="tactical" class="p-2 rounded-lg w-full" title="Tactical"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg></button>
            <button data-view="engineering" class="p-2 rounded-lg w-full" title="Engineering"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 16v-2m8-8h2M4 12H2m15.364 6.364l1.414 1.414M4.222 4.222l1.414 1.414m12.728 0l-1.414 1.414M5.636 18.364l-1.414 1.414M12 16a4 4 0 110-8 4 4 0 010 8z" /></svg></button>
            <button data-view="science" class="p-2 rounded-lg w-full" title="Science"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg></button>
            <button data-view="trader" class="p-2 rounded-lg w-full" title="Trade"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg></button>
        </nav>

        <main style="grid-area: main;" class="p-4 overflow-y-auto">
            <div id="comms-view" class="view active">
                <div class="grid grid-cols-3 gap-4 h-full">
                    <div class="col-span-2 flex flex-col bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)]">
                        <h2 class="text-xl font-orbitron text-[var(--text-cyan)] border-b border-[var(--border-color)] pb-2 mb-2">Comms Log</h2>
                        <div id="comms-log" class="flex-grow overflow-y-auto pr-2"></div>
                        <div id="objective-display" class="mt-4 p-3 bg-black/30 border-t-2 border-amber-500 rounded-b-lg hidden">
                            <h3 class="font-bold text-amber-400">Current Objective:</h3>
                            <p id="objective-text"></p>
                        </div>
                        <div class="mt-4 text-center">
                            <button id="mission-continue-btn" class="hidden bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-md">Continue</button>
                        </div>
                    </div>
                    <div id="player-choice-container" class="bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)] hidden">
                         <h2 class="text-xl font-orbitron text-[var(--text-cyan)] mb-2">Incoming Transmission</h2>
                         <p id="player-choice-prompt" class="mb-4"></p>
                         <div id="player-choice-buttons" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            
            <div id="tactical-view" class="view h-full">
                <div class="grid grid-cols-2 gap-4 h-full">
                    <div class="bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)]">
                        <h2 class="text-xl font-orbitron text-[var(--text-cyan)] mb-2">Targets</h2>
                        <div id="target-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)] space-y-4">
                        <h2 class="text-xl font-orbitron text-[var(--text-cyan)]">Weapons Control</h2>
                        <div class="flex justify-around">
                            <button id="fire-phasers-btn" class="w-32 h-32 bg-red-700 hover:bg-red-600 rounded-full flex flex-col items-center justify-center text-white font-bold text-lg disabled:bg-gray-600 disabled:cursor-not-allowed"><span id="phaser-status">Phasers</span><span id="phaser-timer" class="text-sm"></span></button>
                            <button id="fire-torpedoes-btn" class="w-32 h-32 bg-blue-700 hover:bg-blue-600 rounded-full flex flex-col items-center justify-center text-white font-bold text-lg disabled:bg-gray-600 disabled:cursor-not-allowed"><span id="torpedo-status">Torpedoes</span><span id="torpedo-timer" class="text-sm"></span></button>
                        </div>
                        <div id="torpedo-count" class="text-center text-lg"></div>
                    </div>
                </div>
            </div>

            <div id="engineering-view" class="view">
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)]">
                        <h2 class="text-xl font-orbitron text-[var(--text-cyan)] mb-4">Power Allocation</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="shields-power" class="mb-1 block">Shields</label>
                                <input type="range" id="shields-power" min="10" max="100" value="34" class="w-full">
                            </div>
                            <div>
                                <label for="engines-power" class="mb-1 block">Engines</label>
                                <input type="range" id="engines-power" min="10" max="100" value="33" class="w-full">
                            </div>
                            <div>
                                <label for="weapons-power" class="mb-1 block">Weapons</label>
                                <input type="range" id="weapons-power" min="10" max="100" value="33" class="w-full">
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)]">
                        <h2 class="text-xl font-orbitron text-[var(--text-cyan)] mb-4">System Status & Repair</h2>
                        <div id="system-status-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <div id="science-view" class="view">
                <div class="bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)]">
                    <h2 class="text-xl font-orbitron text-[var(--text-cyan)] mb-2">Sensor Readings</h2>
                    <div id="scan-target-display" class="mb-4">No target selected.</div>
                    <button id="scan-btn" class="bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded-md disabled:bg-gray-600">Scan Target</button>
                    <div id="scan-progress" class="mt-2"></div>
                    <div id="scan-results" class="mt-4 p-2 bg-black/20 rounded"></div>
                </div>
            </div>

            <div id="trader-view" class="view">
                <div class="grid grid-cols-2 gap-4 h-full">
                    <div class="bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)] flex flex-col">
                        <h2 class="text-xl font-orbitron text-[var(--text-cyan)] mb-2">Ship's Cargo</h2>
                        <div id="cargo-hold-list" class="flex-grow overflow-y-auto"></div>
                    </div>
                    <div id="market-panel" class="bg-[var(--panel-bg)] rounded-lg p-4 border border-[var(--border-color)] relative">
                        <div id="no-trader-overlay" class="disabled-overlay rounded-lg">
                            <p class="text-xl">No Trader in Range</p>
                        </div>
                        <h2 class="text-xl font-orbitron text-[var(--text-cyan)] mb-2">Marketplace</h2>
                        <div id="market-list" class="mb-4 flex-grow overflow-y-auto h-64"></div>
                        <div class="flex items-center gap-2">
                            <button id="trader-sell-btn" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded-md disabled:bg-gray-500">Sell</button>
                            <input id="trader-trade-amount" type="number" min="1" value="1" class="w-20 text-center bg-gray-900 border border-gray-600 rounded">
                            <button id="trader-buy-btn" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-md disabled:bg-gray-500">Buy</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer style="grid-area: footer;" class="p-2 bg-black/50 border-t-2 border-[var(--border-color)] flex items-center gap-4">
             <input type="file" id="mission-loader" accept=".js" class="hidden">
             <button id="load-mission-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded disabled:bg-gray-500">Load Mission</button>
             <button id="free-play-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded disabled:bg-gray-500">Free Play</button>
             <p id="loading-message" class="hidden text-amber-400">Generating mission from AI...</p>
        </footer>

        <div id="trader-message-box" class="hidden fullscreen-overlay">
            <div class="bg-gray-800 border-2 border-[var(--border-color)] p-6 rounded-lg max-w-lg text-center">
                <h2 id="trader-name" class="text-2xl font-orbitron text-cyan-400 mb-2"></h2>
                <p id="trader-message-text" class="mb-4"></p>
                <button id="trader-message-ok" class="bg-cyan-600 hover:bg-cyan-500 px-6 py-2 rounded-md">OK</button>
            </div>
        </div>
        <div id="video-player-container" class="hidden fullscreen-overlay p-8">
            <div class="bg-black border-2 border-[var(--border-color)] p-4 rounded-lg w-full max-w-4xl">
                <video id="mission-video" class="w-full" controls></video>
                <button id="close-video-btn" class="mt-4 w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded">Continue Mission</button>
            </div>
        </div>
    </div>

    <script>
        // --- THREE.js Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('viewscreen'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.z = 50;

        // --- Starfield ---
        const starsGeometry = new THREE.BufferGeometry();
        const starsVertices = [];
        for (let i = 0; i < 10000; i++) {
            const x = THREE.MathUtils.randFloatSpread(2000);
            const y = THREE.MathUtils.randFloatSpread(2000);
            const z = THREE.MathUtils.randFloatSpread(2000);
            starsVertices.push(x, y, z);
        }
        starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
        const starsMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 });
        const starField = new THREE.Points(starsGeometry, starsMaterial);
        scene.add(starField);

        // --- UI Elements ---
        const views = document.querySelectorAll('.view');
        const stationNav = document.querySelector('.station-nav');
        const missionTitleDisplay = document.getElementById('mission-title-display');
        const creditsDisplay = document.getElementById('credits-display');
        const hullBar = document.getElementById('hull-bar');
        const commsLog = document.getElementById('comms-log');
        const objectiveDisplay = document.getElementById('objective-display');
        const objectiveText = document.getElementById('objective-text');
        const missionContinueBtn = document.getElementById('mission-continue-btn');
        const playerChoiceContainer = document.getElementById('player-choice-container');
        const playerChoicePrompt = document.getElementById('player-choice-prompt');
        const playerChoiceButtons = document.getElementById('player-choice-buttons');
        const targetList = document.getElementById('target-list');
        const firePhasersBtn = document.getElementById('fire-phasers-btn');
        const phaserStatus = document.getElementById('phaser-status');
        const phaserTimer = document.getElementById('phaser-timer');
        const fireTorpedoesBtn = document.getElementById('fire-torpedoes-btn');
        const torpedoStatus = document.getElementById('torpedo-status');
        const torpedoTimer = document.getElementById('torpedo-timer');
        const torpedoCount = document.getElementById('torpedo-count');
        const shieldsSlider = document.getElementById('shields-power');
        const enginesSlider = document.getElementById('engines-power');
        const weaponsSlider = document.getElementById('weapons-power');
        const systemStatusList = document.getElementById('system-status-list');
        const scanTargetDisplay = document.getElementById('scan-target-display');
        const scanBtn = document.getElementById('scan-btn');
        const scanProgress = document.getElementById('scan-progress');
        const scanResults = document.getElementById('scan-results');
        const cargoHoldList = document.getElementById('cargo-hold-list');
        const marketPanel = document.getElementById('market-panel');
        const noTraderOverlay = document.getElementById('no-trader-overlay');
        const marketList = document.getElementById('market-list');
        const traderSellBtn = document.getElementById('trader-sell-btn');
        const traderTradeAmountInput = document.getElementById('trader-trade-amount');
        const traderBuyBtn = document.getElementById('trader-buy-btn');
        const traderMessageBox = document.getElementById('trader-message-box');
        const traderName = document.getElementById('trader-name');
        const traderMessageText = document.getElementById('trader-message-text');
        const traderMessageOk = document.getElementById('trader-message-ok');
        const missionLoader = document.getElementById('mission-loader');
        const loadMissionBtn = document.getElementById('load-mission-btn');
        const freePlayBtn = document.getElementById('free-play-btn');
        const loadingMessage = document.getElementById('loading-message');
        const videoPlayerContainer = document.getElementById('video-player-container');
        const missionVideo = document.getElementById('mission-video');
        const closeVideoBtn = document.getElementById('close-video-btn');


        // --- Game State ---
        let gameState = {
            ship: {
                maxHull: 100,
                hull: 100,
                credits: 1000,
                power: {
                    shields: 34,
                    engines: 33,
                    weapons: 33,
                },
                systems: {
                    shields: { status: 'operational', repair: 0 },
                    engines: { status: 'operational', repair: 0 },
                    weapons: { status: 'operational', repair: 0 },
                },
                weapons: {
                    phasers: { ready: true, cooldown: 3000 },
                    torpedoes: { ready: true, cooldown: 8000, count: 10 },
                },
                cargo: {
                    tritanium: 20,
                    dilithium: 5,
                },
                targetId: null,
            },
            enemies: [],
            trader: null,
            mission: {
                currentEventIndex: 0,
                events: [],
                variables: {},
                isWaitingForDefeat: false,
                isWaitingForContinue: false,
            }
        };

        // --- Helper Functions ---
        function addCommsLog(speaker, message) {
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<p><strong class="text-[var(--text-cyan)]">${speaker}:</strong> ${message}</p>`;
            commsLog.appendChild(logEntry);
            commsLog.scrollTop = commsLog.scrollHeight;
        }

        function showNotification(viewName) {
            const button = stationNav.querySelector(`button[data-view="${viewName}"]`);
            if (button) button.classList.add('has-notification');
        }

        function clearNotification(viewName) {
            const button = stationNav.querySelector(`button[data-view="${viewName}"]`);
            if (button) button.classList.remove('has-notification');
        }

        // --- Mission Logic ---
        function loadMission(missionData) {
            console.log("Loading mission:", missionData.title);
            // Reset game state for new mission
            gameState.mission.events = missionData.events;
            gameState.mission.currentEventIndex = 0;
            gameState.mission.variables = {};
            gameState.mission.isWaitingForDefeat = false;
            gameState.mission.isWaitingForContinue = false;
            gameState.enemies = [];
            scene.children.filter(c => c.userData.isEnemy).forEach(c => scene.remove(c));
            
            missionTitleDisplay.textContent = missionData.title;
            commsLog.innerHTML = '';
            addCommsLog("SYSTEM", `Mission "${missionData.title}" initialized.`);
            processMissionEvent(gameState.mission.events[0]);
            updateAllUI();
        }

        function advanceMission() {
            gameState.mission.currentEventIndex++;
            const nextEvent = gameState.mission.events[gameState.mission.currentEventIndex];
            if (nextEvent) {
                processMissionEvent(nextEvent);
            } else {
                addCommsLog("SYSTEM", "Mission sequence complete.");
            }
        }
        
        function processMissionEvent(event) {
            if (!event) return;
            let isMissionAdvancing = true;

            switch (event.type) {
                case 'dialogue':
                    addCommsLog(event.speaker, event.message);
                    showNotification('comms');
                    missionContinueBtn.classList.remove('hidden');
                    gameState.mission.isWaitingForContinue = true;
                    isMissionAdvancing = false;
                    break;
                case 'play_video':
                    addCommsLog('SYSTEM', event.message || 'Incoming video transmission.');
                    missionVideo.src = event.url;
                    videoPlayerContainer.classList.remove('hidden');
                    missionVideo.play();
                    isMissionAdvancing = false;
                    break;
                case 'spawn_enemy':
                    const enemyId = `enemy_${Date.now()}`;
                    const enemy = { 
                        id: enemyId,
                        name: event.name,
                        maxHull: event.hull,
                        hull: event.hull,
                        behavior: event.behavior,
                        isScanned: false,
                        weakness: ['phasers', 'torpedoes'][Math.floor(Math.random() * 2)],
                    };
                    gameState.enemies.push(enemy);

                    const geometry = new THREE.ConeGeometry(5, 20, 4);
                    const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    const cone = new THREE.Mesh(geometry, material);
                    cone.name = enemyId;
                    cone.userData.isEnemy = true;
                    cone.position.set(Math.random() * 100 - 50, Math.random() * 50 - 25, -200);
                    cone.rotation.x = Math.PI / 2;
                    scene.add(cone);
                    
                    addCommsLog('SENSORS', `Hostile contact detected: ${enemy.name}.`);
                    showNotification('tactical');
                    
                    if (event.waitForAllDefeated) {
                        gameState.mission.isWaitingForDefeat = true;
                        isMissionAdvancing = false;
                    }
                    break;
                case 'system_damage':
                    if (gameState.ship.systems[event.system]) {
                        gameState.ship.systems[event.system].status = 'damaged';
                        gameState.ship.systems[event.system].repair = 0;
                        addCommsLog('ENGINEERING', event.message);
                        showNotification('engineering');
                    }
                    break;
                case 'spawn_trader':
                    gameState.trader = { name: event.name, market: event.market || [], isOpen: true };
                    traderName.textContent = event.name;
                    traderMessageText.textContent = event.message || `Welcome to ${event.name}.`;
                    traderMessageBox.classList.remove('hidden');
                    showNotification('trader');
                    break;
                 case 'give_reward':
                    if (event.reward_type === 'credits') {
                        gameState.ship.credits += event.amount;
                    } else if (event.reward_type === 'cargo' && event.resource) {
                        gameState.ship.cargo[event.resource] = (gameState.ship.cargo[event.resource] || 0) + event.amount;
                    }
                    if (event.message) addCommsLog('SYSTEM', event.message);
                    showNotification('trader');
                    break;
                case 'set_objective':
                    objectiveText.textContent = event.message;
                    objectiveDisplay.classList.remove('hidden');
                    showNotification('comms');
                    break;
                case 'clear_objective':
                    objectiveDisplay.classList.add('hidden');
                    break;
                case 'player_choice':
                    playerChoicePrompt.textContent = event.message;
                    playerChoiceButtons.innerHTML = '';
                    event.choices.forEach(choice => {
                        const button = document.createElement('button');
                        button.textContent = choice.text;
                        button.className = 'w-full bg-cyan-700 hover:bg-cyan-600 p-2 rounded';
                        button.onclick = () => {
                            gameState.mission.variables[event.variable] = choice.value;
                            playerChoiceContainer.classList.add('hidden');
                            addCommsLog('COMMAND', `Selected: ${choice.text}`);
                            advanceMission();
                        };
                        playerChoiceButtons.appendChild(button);
                    });
                    playerChoiceContainer.classList.remove('hidden');
                    isMissionAdvancing = false;
                    break;
                case 'wait':
                    setTimeout(advanceMission, event.duration);
                    isMissionAdvancing = false;
                    break;
                case 'end_mission':
                    addCommsLog("SYSTEM", "Mission Ended.");
                    missionTitleDisplay.textContent = event.title;
                    // Could show a mission end screen here
                    break;
                default:
                    console.warn('Unknown event type:', event.type);
            }
            if (isMissionAdvancing) advanceMission();
            updateAllUI();
        }

        // --- AI Mission Generation ---
        async function generateFreePlayMission() {
            loadMissionBtn.disabled = true;
            freePlayBtn.disabled = true;
            loadingMessage.classList.remove('hidden');
            addCommsLog("SYSTEM", "Requesting a new mission scenario from the AI...");

            const prompt = `
                You are a mission designer for a spaceship bridge simulator game. Create a short, random, and coherent mission.
                Your response MUST be ONLY a valid JSON object. Do not include markdown formatting like \`\`\`json or any text outside of the JSON object itself.
                The JSON object must have a 'title' (string) and an 'events' (array of objects).
                Generate a mission with 5 to 10 events. It should have a beginning, a middle, and an end.
                
                Here are the available event types and their parameters (use these exact structures inside the 'events' array):
                - { "type": "dialogue", "speaker": "STRING", "message": "STRING" }
                - { "type": "spawn_enemy", "name": "STRING", "hull": NUMBER, "behavior": "passive" or "aggressive", "waitForAllDefeated": BOOLEAN }
                - { "type": "system_damage", "system": "shields" or "engines" or "weapons", "message": "STRING" }
                - { "type": "spawn_trader", "name": "STRING", "message": "STRING", "market": [{ "resource": "STRING", "buyPrice": NUMBER, "sellPrice": NUMBER }] }
                - { "type": "give_reward", "reward_type": "credits" or "cargo", "amount": NUMBER, "resource": "STRING" (if cargo), "message": "STRING" }
                - { "type": "set_objective", "message": "STRING" }
                - { "type": "clear_objective" }
                - { "type": "player_choice", "message": "STRING", "variable": "STRING", "choices": [{ "text": "STRING", "value": "STRING" }] }
                - { "type": "wait", "duration": NUMBER (in ms) }
                - { "type": "end_mission", "title": "STRING", "message": "STRING" }

                Create a mission scenario based on one of these ideas: a surprise pirate attack, a diplomatic negotiation, a rescue mission, or investigating a strange anomaly.
                Ensure the mission ends with an 'end_mission' event.
            `;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Body:", errorBody);
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const missionData = JSON.parse(jsonText);
                    if (missionData && missionData.title && missionData.events) {
                        addCommsLog("AI", "New mission generated successfully. Initializing now.");
                        loadMission(missionData);
                    } else {
                         throw new Error("AI response was not a valid mission object.");
                    }
                } else {
                    throw new Error("No content received from AI.");
                }
            } catch (error) {
                console.error("Free Play Generation Error:", error);
                addCommsLog("SYSTEM", "Error: The AI failed to generate a mission. Please try again.");
            } finally {
                loadMissionBtn.disabled = false;
                freePlayBtn.disabled = false;
                loadingMessage.classList.add('hidden');
            }
        }
        
        // --- Game Loop ---
        function gameLoop() {
            requestAnimationFrame(gameLoop);
            // Starfield rotation
            starField.rotation.x += 0.0001;
            starField.rotation.y += 0.0001;
            renderer.render(scene, camera);
        }

        // --- UI Update Functions ---
        function updateAllUI() {
            creditsDisplay.textContent = `Credits: ${gameState.ship.credits}`;
            const hullPercent = (gameState.ship.hull / gameState.ship.maxHull) * 100;
            hullBar.style.width = `${hullPercent}%`;
            hullBar.textContent = `${Math.round(hullPercent)}%`;
            hullBar.className = 'progress-bar-fill text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-full ';
            if (hullPercent > 60) hullBar.classList.add('hull-ok');
            else if (hullPercent > 25) hullBar.classList.add('hull-warn');
            else hullBar.classList.add('hull-crit');
            updateTacticalUI();
            updateEngineeringUI();
            updateScienceUI();
            updateTraderUI();
        }

        function updateTacticalUI() {
            targetList.innerHTML = '';
            if (gameState.enemies.length === 0) {
                targetList.innerHTML = '<p>No targets on sensors.</p>';
            } else {
                gameState.enemies.forEach(enemy => {
                    const isTargeted = gameState.ship.targetId === enemy.id;
                    targetList.innerHTML += `
                        <div class="p-2 rounded border ${isTargeted ? 'border-red-500 bg-red-900/50' : 'border-gray-600'}">
                            <div class="flex justify-between items-center">
                                <span>${enemy.name}</span>
                                <button class="target-btn bg-red-600 hover:bg-red-500 px-2 py-1 rounded-sm text-xs" data-id="${enemy.id}">${isTargeted ? 'Targeted' : 'Target'}</button>
                            </div>
                            <div class="text-sm">Hull: ${enemy.hull}/${enemy.maxHull}</div>
                        </div>
                    `;
                });
            }
            torpedoCount.textContent = `Torpedoes: ${gameState.ship.weapons.torpedoes.count}`;
            firePhasersBtn.disabled = !gameState.ship.weapons.phasers.ready || !gameState.ship.targetId || gameState.ship.systems.weapons.status === 'damaged';
            fireTorpedoesBtn.disabled = !gameState.ship.weapons.torpedoes.ready || !gameState.ship.targetId || gameState.ship.weapons.torpedoes.count <= 0 || gameState.ship.systems.weapons.status === 'damaged';
        }

        function updateEngineeringUI() {
            systemStatusList.innerHTML = '';
            Object.keys(gameState.ship.systems).forEach(sysKey => {
                const system = gameState.ship.systems[sysKey];
                const isDamaged = system.status === 'damaged';
                systemStatusList.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center">
                            <span class="capitalize ${isDamaged ? 'text-red-400' : ''}">${sysKey}</span>
                            <span class="font-bold ${isDamaged ? 'text-red-400' : 'text-green-400'}">${system.status}</span>
                        </div>
                        ${isDamaged ? `<div class="mt-1"><div class="progress-bar-bg rounded-full"><div class="bg-yellow-500 rounded-full h-4" style="width: ${system.repair}%"></div></div><button class="repair-btn mt-1 bg-cyan-700 hover:bg-cyan-600 text-xs px-2 py-1 rounded" data-system="${sysKey}">Repair (+20%)</button></div>` : ''}
                    </div>
                `;
            });
        }

        function updateScienceUI() {
            const target = gameState.enemies.find(e => e.id === gameState.ship.targetId);
            if (target) {
                scanTargetDisplay.textContent = `Target: ${target.name}`;
                scanBtn.disabled = target.isScanned;
                if (target.isScanned) {
                    scanResults.innerHTML = `
                        <p><strong>Scan Complete</strong></p>
                        <p>Hull: ${target.hull}/${target.maxHull}</p>
                        <p>Weakness Detected: <strong class="text-amber-400">${target.weakness.toUpperCase()}</strong></p>
                    `;
                } else {
                    scanResults.innerHTML = '<p>Awaiting scan...</p>';
                }
            } else {
                scanTargetDisplay.textContent = 'No target selected.';
                scanBtn.disabled = true;
                scanResults.innerHTML = '';
            }
        }
        
        function updateTraderUI() {
            cargoHoldList.innerHTML = '';
            Object.entries(gameState.ship.cargo).forEach(([resource, amount]) => {
                cargoHoldList.innerHTML += `<div class="flex justify-between p-1"><span>${resource}</span><span>${amount}</span></div>`;
            });
            noTraderOverlay.classList.toggle('hidden', !!gameState.trader);
            marketPanel.classList.toggle('opacity-50', !gameState.trader);
            if (gameState.trader) {
                marketList.innerHTML = '';
                gameState.trader.market.forEach(item => {
                    marketList.innerHTML += `<div class="grid grid-cols-3 gap-2 p-1 border-b border-gray-700"><span>${item.resource}</span><span>Buy: ${item.buyPrice}cr</span><span>Sell: ${item.sellPrice}cr</span></div>`;
                });
            }
            updateTraderMarketButtons();
        }

        function updateTraderMarketButtons() {
            const amount = parseInt(traderTradeAmountInput.value) || 0;
            traderBuyBtn.disabled = !gameState.trader || amount <= 0;
            traderSellBtn.disabled = !gameState.trader || amount <= 0;
        }

        // --- Event Handlers ---
        function handlePowerChange() {
            const sliders = [shieldsSlider, enginesSlider, weaponsSlider];
            let total = sliders.reduce((sum, s) => sum + parseInt(s.value), 0);
            
            gameState.ship.power.shields = parseInt(shieldsSlider.value);
            gameState.ship.power.engines = parseInt(enginesSlider.value);
            gameState.ship.power.weapons = parseInt(weaponsSlider.value);
            
            // This is a simplified power model. A more complex one might enforce a total of 100.
            updateAllUI();
        }

        function handleWeaponCooldown(btn, status, timer, name, cooldown) {
            status.textContent = 'Charging...';
            let timeLeft = cooldown / 1000;
            timer.textContent = `${timeLeft}s`;
            const interval = setInterval(() => {
                timeLeft--;
                timer.textContent = timeLeft > 0 ? `${timeLeft}s` : '';
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    btn.disabled = false;
                    status.textContent = name;
                }
            }, 1000);
        }

        function checkEnemyDefeat(enemy) {
            if (enemy.hull <= 0) {
                addCommsLog('SYSTEM', `${enemy.name} has been destroyed.`);
                const object3d = scene.getObjectByName(enemy.id);
                if (object3d) scene.remove(object3d);
                gameState.enemies = gameState.enemies.filter(e => e.id !== enemy.id);
                if (gameState.ship.targetId === enemy.id) gameState.ship.targetId = null;
                updateAllUI();
                if (gameState.mission.isWaitingForDefeat && gameState.enemies.length === 0) {
                    gameState.mission.isWaitingForDefeat = false;
                    advanceMission();
                }
            }
        }
        function buyResource() { /* ...logic... */ }
        function sellResource() { /* ...logic... */ }

        // --- Event Listeners ---
        stationNav.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.view) {
                const viewName = button.dataset.view;
                views.forEach(v => v.classList.toggle('active', v.id === `${viewName}-view`));
                stationNav.querySelectorAll('button').forEach(b => b.classList.toggle('active', b === button));
                clearNotification(viewName);
            }
        });
        
        missionContinueBtn.addEventListener('click', () => {
            if (gameState.mission.isWaitingForContinue) {
                missionContinueBtn.classList.add('hidden');
                gameState.mission.isWaitingForContinue = false;
                advanceMission();
            }
        });
        
        loadMissionBtn.addEventListener('click', () => missionLoader.click());
        missionLoader.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const script = document.createElement('script');
                script.innerHTML = e.target.result;
                document.body.appendChild(script);
                if (window.currentLoadedMission) {
                    loadMission(window.currentLoadedMission);
                    window.currentLoadedMission = null;
                } else {
                    console.error("Mission file did not define window.currentLoadedMission correctly.");
                    addCommsLog("SYSTEM", "Error: Could not load mission file. It may be corrupted or in the wrong format.");
                }
                document.body.removeChild(script);
            };
            reader.readAsText(file);
        });

        freePlayBtn.addEventListener('click', generateFreePlayMission);
        
        closeVideoBtn.addEventListener('click', () => {
            videoPlayerContainer.classList.add('hidden');
            missionVideo.pause();
            missionVideo.src = '';
            advanceMission();
        });

        targetList.addEventListener('click', (e) => {
            if (e.target.classList.contains('target-btn')) {
                gameState.ship.targetId = e.target.dataset.id;
                updateAllUI();
            }
        });

        firePhasersBtn.addEventListener('click', () => {
            const btn = firePhasersBtn;
            if (btn.disabled) return;
            const target = gameState.enemies.find(e => e.id === gameState.ship.targetId);
            if (target) {
                let damage = 10 + Math.floor(gameState.ship.power.weapons / 10);
                if (target.isScanned && target.weakness === 'phasers') damage *= 2;
                target.hull = Math.max(0, target.hull - damage);
                
                btn.disabled = true;
                gameState.ship.weapons.phasers.ready = false;
                handleWeaponCooldown(btn, phaserStatus, phaserTimer, "Phasers", gameState.ship.weapons.phasers.cooldown);
                setTimeout(() => { gameState.ship.weapons.phasers.ready = true; updateAllUI(); }, gameState.ship.weapons.phasers.cooldown);

                updateAllUI();
                checkEnemyDefeat(target);
            }
        });

        fireTorpedoesBtn.addEventListener('click', () => {
            const btn = fireTorpedoesBtn;
            if (btn.disabled) return;
            const target = gameState.enemies.find(e => e.id === gameState.ship.targetId);
            if (target) {
                let damage = 35;
                if (target.isScanned && target.weakness === 'torpedoes') damage *= 2;
                target.hull = Math.max(0, target.hull - damage);
                gameState.ship.weapons.torpedoes.count--;

                btn.disabled = true;
                gameState.ship.weapons.torpedoes.ready = false;
                handleWeaponCooldown(btn, torpedoStatus, torpedoTimer, "Torpedoes", gameState.ship.weapons.torpedoes.cooldown);
                setTimeout(() => { gameState.ship.weapons.torpedoes.ready = true; updateAllUI(); }, gameState.ship.weapons.torpedoes.cooldown);
                
                updateAllUI();
                checkEnemyDefeat(target);
            }
        });
        
        systemStatusList.addEventListener('click', e => {
            if (e.target.classList.contains('repair-btn')) {
                const systemKey = e.target.dataset.system;
                const system = gameState.ship.systems[systemKey];
                if(system.status === 'damaged') {
                    system.repair = Math.min(100, system.repair + 20);
                    if (system.repair >= 100) {
                        system.status = 'operational';
                        system.repair = 0;
                        addCommsLog('ENGINEERING', `${systemKey.charAt(0).toUpperCase() + systemKey.slice(1)} repaired and back online.`);
                    }
                    updateAllUI();
                }
            }
        });
        
        [shieldsSlider, enginesSlider, weaponsSlider].forEach(slider => { slider.addEventListener('input', handlePowerChange); });
        
        scanBtn.addEventListener('click', () => {
            const target = gameState.enemies.find(e => e.id === gameState.ship.targetId);
            if (target && !target.isScanned) {
                scanBtn.disabled = true;
                let progress = 0;
                scanProgress.textContent = `Scanning... ${progress}%`;
                const scanInterval = setInterval(() => {
                    progress += 20;
                    scanProgress.textContent = `Scanning... ${progress}%`;
                    if (progress >= 100) {
                        clearInterval(scanInterval);
                        target.isScanned = true;
                        addCommsLog('SCIENCE', `Scan of ${target.name} complete.`);
                        scanProgress.textContent = '';
                        updateAllUI();
                    }
                }, 1000);
            }
        });
        
        traderBuyBtn.addEventListener('click', buyResource);
        traderSellBtn.addEventListener('click', sellResource);
        traderTradeAmountInput.addEventListener('input', updateTraderMarketButtons);
        traderMessageOk.addEventListener('click', () => traderMessageBox.classList.add('hidden'));

        // --- Init ---
        updateAllUI();
        gameLoop();
    </script>
</body>
</html>

