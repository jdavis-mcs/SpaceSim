<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaceship Bridge Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --panel-border-color: #22d3ee;
            --panel-glow-color: rgba(34, 211, 238, 0.3);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-highlight: #67e8f9;
            --alert-color: #f43f5e;
            --alert-glow-color: rgba(244, 63, 94, 0.5);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: var(--text-primary);
            overflow: hidden;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }

        .simulator-container {
            display: grid;
            grid-template-rows: 60% auto;
            gap: 1rem;
            width: 100%;
            height: 100%;
            max-width: 1600px;
            max-height: 900px;
            aspect-ratio: 16 / 9;
            border: 2px solid var(--panel-border-color);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 0 30px var(--panel-glow-color);
            background: #08152b;
        }

        .panels-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            min-height: 0;
        }
        @media (min-width: 768px) { .panels-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1280px) { .panels-grid { grid-template-columns: repeat(4, 1fr); } }

        .panel {
            background-color: rgba(10, 20, 40, 0.8);
            border: 1px solid var(--panel-border-color);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-shadow: inset 0 0 8px rgba(34, 211, 238, 0.2);
        }
        .panel-header {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            color: var(--text-highlight);
            border-bottom: 2px solid var(--panel-border-color);
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }
        .panel-content {
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--panel-border-color) #083344;
            padding: 0 0.75rem 0.75rem;
        }
        .viewscreen {
            background-color: #000;
            border: 2px solid var(--panel-border-color);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .damage-flash { animation: flash-red 0.3s forwards; }
        @keyframes flash-red { 50% { box-shadow: 0 0 40px var(--alert-color); } }
        @keyframes twinkle { to { opacity: 0.2; } }
        
        #hazard-warning {
            animation: pulse-warning 2s infinite;
        }
        @keyframes pulse-warning { 50% { box-shadow: inset 0 0 40px var(--alert-glow-color), 0 0 40px var(--alert-glow-color); } }

        .btn-danger { @apply bg-red-600 hover:bg-red-500 disabled:bg-red-800 border-red-400; box-shadow: 0 0 8px rgba(244, 63, 94, 0.5); }

        .player-ship { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; filter: drop-shadow(0 0 5px var(--text-highlight)); }
        .enemy-ship { position: absolute; width: 20px; height: 20px; background-color: #f43f5e; border-radius: 50%; box-shadow: 0 0 10px #f43f5e; transition: all 0.5s ease; animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-red { 50% { opacity: 0.7; transform: scale(1.2); } }
        
        .btn { @apply px-4 py-2 rounded-md font-semibold text-white transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-primary { @apply bg-cyan-500 hover:bg-cyan-400 disabled:bg-cyan-700; border: 1px solid var(--text-highlight); box-shadow: 0 0 8px rgba(103, 232, 249, 0.5); }
        .btn-secondary { @apply bg-slate-600 hover:bg-slate-500 disabled:bg-slate-700; border: 1px solid var(--text-secondary); }
        
        .target-btn { @apply w-full text-left p-2 rounded-md transition-colors duration-200; }
        .target-btn.selected { @apply bg-cyan-800 ring-2 ring-cyan-400; }
        .target-btn:not(.selected):hover { @apply bg-slate-700; }

        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--text-highlight); cursor: pointer; border-radius: 50%; border: 2px solid #083344; margin-top: -8px; }
        .slider-thumb::-moz-range-thumb { width: 20px; height: 20px; background: var(--text-highlight); cursor: pointer; border-radius: 50%; border: 2px solid #083344; }
    </style>
</head>
<body class="bg-slate-950 flex items-center justify-center h-screen p-4">

    <div id="setup-screen" class="max-w-lg w-full">
        <div class="panel p-8 text-center">
            <h1 class="font-orbitron text-4xl mb-4 text-cyan-300">Bridge Simulator</h1>
            <p class="mb-6 text-slate-400">Load a mission file to begin the simulation.</p>
            <input type="file" id="mission-file-input" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-900 file:text-cyan-300 hover:file:bg-cyan-800 mb-4"/>
            <p id="mission-status" class="text-sm text-yellow-400 h-5 mb-4"></p>
            <button id="engage-btn" class="btn btn-primary w-full text-lg" disabled>Engage</button>
            <p class="text-gray">v1.3</p>
        </div>
    </div>

    <main id="bridge-ui" class="hidden simulator-container">
        
        <div id="viewscreen" class="viewscreen">
             <div id="hazard-warning" class="hidden absolute inset-0 border-8 border-red-500 rounded-lg pointer-events-none">
                <div class="absolute top-2 left-1/2 -translate-x-1/2 bg-red-600 px-4 py-1 rounded-md font-orbitron text-lg tracking-widest">HAZARD DETECTED</div>
            </div>
            <svg class="player-ship" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g transform="scale(1.2) translate(0, -5)">
                    <polygon points="50,0 100,100 50,75 0,100" fill="#22d3ee"/>
                    <polygon points="50,15 85,90 50,70 15,90" fill="#083344"/>
                </g>
            </svg>
        </div>

        <div class="panels-grid">
            
            <div id="comms-panel" class="panel">
                <h2 class="panel-header text-lg">Comms</h2>
                <div id="objective-display" class="p-2 mb-2 bg-slate-900/50 rounded-md hidden"></div>
                <div id="comms-log" class="panel-content space-y-3"></div>
            </div>

            <div class="panel">
                <h2 class="panel-header text-lg">Science</h2>
                <div id="science-content" class="panel-content flex flex-col justify-center items-center text-center">
                    <p class="text-slate-400">Awaiting target for scan...</p>
                </div>
            </div>

            <div class="panel">
                <h2 class="panel-header text-lg">Engineering</h2>
                <div id="engineering-alerts" class="p-2 space-y-2"></div>
                <div class="panel-content space-y-4 pt-2">
                    <div>
                        <label for="shields-slider" class="flex justify-between text-sm"><span>Shields</span><span id="shields-power-value">34%</span></label>
                        <input id="shields-slider" type="range" min="0" max="100" value="34" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                        <div id="shields-bonus-text" class="text-xs text-cyan-300 text-center h-4"></div>
                    </div>
                    <div>
                        <label for="engines-slider" class="flex justify-between text-sm"><span>Engines</span><span id="engines-power-value">33%</span></label>
                        <input id="engines-slider" type="range" min="0" max="100" value="33" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                        <div id="engines-bonus-text" class="text-xs text-cyan-300 text-center h-4"></div>
                    </div>
                    <div>
                        <label for="weapons-slider" class="flex justify-between text-sm"><span>Weapons</span><span id="weapons-power-value">33%</span></label>
                        <input id="weapons-slider" type="range" min="0" max="100" value="33" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                         <div id="weapons-bonus-text" class="text-xs text-cyan-300 text-center h-4"></div>
                    </div>
                     <div class="!mt-auto">
                        <h3 class="font-orbitron text-md text-center">Ship Status</h3>
                         <div class="space-y-2 text-sm mt-2">
                            <div class="flex justify-between"><span>Hull:</span> <span id="hull-status">100%</span></div>
                            <div class="w-full bg-slate-700 rounded-full h-2.5"><div id="hull-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 100%"></div></div>
                            <div class="flex justify-between"><span>Shields:</span> <span id="shields-status">100%</span></div>
                            <div class="w-full bg-slate-700 rounded-full h-2.5"><div id="shields-bar" class="bg-cyan-400 h-2.5 rounded-full" style="width: 100%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="weapons-panel" class="panel">
                <h2 class="panel-header text-lg">Weapons Control</h2>
                <div class="panel-content flex flex-col h-full min-h-0">
                    <div class="flex-shrink-0 mb-2">
                        <p class="text-sm font-semibold mb-1">Targets:</p>
                        <div id="targets-list" class="flex-grow border border-slate-600 rounded-md p-1 space-y-1 overflow-y-auto">
                             <p class="text-slate-400 text-center p-2">No targets detected.</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 grid grid-cols-2 gap-2 mt-2">
                        <button id="fire-phasers-btn" class="btn btn-primary h-16">Fire Phasers</button>
                        <button id="fire-torpedoes-btn" class="btn btn-primary h-16">Fire Torpedoes (<span id="torpedo-count">5</span>)</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        const setupScreen = document.getElementById('setup-screen');
        const missionFileInput = document.getElementById('mission-file-input');
        const engageBtn = document.getElementById('engage-btn');
        const bridgeUI = document.getElementById('bridge-ui');
        const viewscreen = document.getElementById('viewscreen');
        const commsLog = document.getElementById('comms-log');
        const hullStatus = document.getElementById('hull-status');
        const hullBar = document.getElementById('hull-bar');
        const shieldsStatus = document.getElementById('shields-status');
        const shieldsBar = document.getElementById('shields-bar');
        const scienceContent = document.getElementById('science-content');
        const targetsList = document.getElementById('targets-list');
        const firePhasersBtn = document.getElementById('fire-phasers-btn');
        const fireTorpedoesBtn = document.getElementById('fire-torpedoes-btn');
        const torpedoCountSpan = document.getElementById('torpedo-count');
        const shieldsSlider = document.getElementById('shields-slider');
        const enginesSlider = document.getElementById('engines-slider');
        const weaponsSlider = document.getElementById('weapons-slider');
        const missionStatus = document.getElementById('mission-status');
        const objectiveDisplay = document.getElementById('objective-display');
        const engineeringAlerts = document.getElementById('engineering-alerts');
        const hazardWarning = document.getElementById('hazard-warning');

        let missionScript = null;
        let gameState = {};
        let activeSounds = {}; // To manage looping sounds

        // --- Sound Engine ---
        function playSound(src, loop = false) {
            // Don't play if a looping sound with the same src is already active
            if (loop && activeSounds[src]) {
                return;
            }
            const audio = new Audio(src);
            audio.loop = loop;
            // User interaction is required for audio to play in most browsers.
            // We'll rely on the initial "Engage" click to allow audio.
            audio.play().catch(e => {
                // This error often happens if the user hasn't interacted with the page yet.
                console.warn(`Could not play sound: ${src}. User interaction may be required.`, e);
            });
            if (loop) {
                activeSounds[src] = audio;
            }
        }

        function stopSound(src) {
            if (activeSounds[src]) {
                activeSounds[src].pause();
                activeSounds[src].currentTime = 0;
                delete activeSounds[src];
            }
        }
        
        function stopAllSounds() {
            for (const src in activeSounds) {
                stopSound(src);
            }
        }

        function resetGameState() {
            // ... (rest of the function is the same)
            gameState = {
                ship: {
                    hull: 100,
                    shields: 100,
                    power: { shields: 34, engines: 33, weapons: 33 },
                    powerEffects: { shieldRegenBonus: 0, evasionChance: 0, weaponCooldownReduction: 0 },
                    systems: { shields: 'operational', engines: 'operational', weapons: 'operational' },
                    weapons: {
                        phasers: { name: 'Phasers', cooldown: 2000, ready: true },
                        torpedoes: { name: 'Torpedoes', cooldown: 8000, ready: true, count: 5 }
                    },
                    targetId: null,
                },
                enemies: [],
                eventIndex: 0,
                isPaused: false,
                missionVariables: {},
                currentObjective: null,
                currentHazard: null,
            };
        }
        
        missionFileInput.addEventListener('change', (event) => {
            // ... (rest of the function is the same)
            const file = event.target.files[0]; if (!file) return;
            engageBtn.disabled = true; missionStatus.textContent = "Loading mission...";
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    const missionString = content.substring(content.indexOf('{'));
                    const missionObj = (new Function(`return ${missionString}`))();
                    if (missionObj && missionObj.title && missionObj.events) {
                        missionScript = missionObj;
                        engageBtn.disabled = false;
                        missionStatus.textContent = `Mission "${missionScript.title}" loaded.`;
                    } else { throw new Error("Invalid mission structure."); }
                } catch (error) {
                    console.error("Error parsing mission file:", error);
                    missionStatus.textContent = "Error: Failed to parse mission file.";
                    missionScript = null;
                }
            };
            reader.readAsText(file);
        });

        engageBtn.addEventListener('click', () => { if (missionScript) { startGame(); } });

        function startGame() {
            // ... (rest of the function is the same)
            resetGameState();
            setupScreen.classList.add('hidden');
            bridgeUI.classList.remove('hidden'); bridgeUI.classList.add('grid');
            updatePowerUI(); updateShipStatusUI(); updateTargetsUI(); createStarfield();
            setInterval(regenerateShields, 2000);
            setInterval(gameLoop, 3000);
            processNextEvent();
        }

        function processNextEvent() {
            if (gameState.isPaused || gameState.eventIndex >= missionScript.events.length) return;
            const event = missionScript.events[gameState.eventIndex]; let advance = true;
            switch (event.type) {
                case 'dialogue': addCommsLog(event.speaker, event.message); break;
                // ... (other cases are the same)
                case 'sound':
                    playSound(event.src, event.loop || false);
                    break;
                case 'stop_sound':
                    stopSound(event.src);
                    break;
                case 'wait':
                    gameState.isPaused = true;
                    setTimeout(() => {
                        gameState.isPaused = false; gameState.eventIndex++; processNextEvent();
                    }, event.duration);
                    advance = false;
                    break;
                case 'spawn_enemy':
                    const newEnemy = { id: `enemy_${Date.now()}_${Math.random()}`, name: event.name, hull: event.hull, weakness: event.weakness, isScanned: false };
                    gameState.enemies.push(newEnemy); spawnEnemyOnViewscreen(newEnemy); updateTargetsUI();
                    break;
                case 'choice': gameState.isPaused = true; displayChoice(event); advance = false; break;
                case 'label': break;
                case 'jump':
                    let doJump = true;
                    if (event.condition) {
                        switch (event.condition.type) {
                            case 'enemies_exist': doJump = gameState.enemies.length > 0; break;
                            case 'variable_not_set': doJump = !gameState.missionVariables[event.condition.variable]; break;
                        }
                    }
                    if (doJump) {
                        const targetIndex = missionScript.events.findIndex(e => e.type === 'label' && e.name === event.target);
                        if (targetIndex !== -1) { gameState.eventIndex = targetIndex; }
                    }
                    break;
                case 'anomaly': gameState.isPaused = true; addCommsLog('SCIENCE', `Unusual signature detected: ${event.name}.`); displayAnomaly(event); advance = false; break;
                case 'system_damage':
                    playSound('placeholder/system_alert.mp3');
                    gameState.ship.systems[event.system] = 'damaged';
                    addCommsLog('ENGINEERING', `CRITICAL: ${event.system.toUpperCase()} system damaged!`);
                    updateEngineeringUI();
                    break;
                case 'set_objective':
                    gameState.currentObjective = event.message;
                    updateObjectiveUI();
                    break;
                case 'clear_objective':
                    gameState.currentObjective = null;
                    updateObjectiveUI();
                    break;
                case 'environmental_hazard':
                    gameState.currentHazard = { type: event.hazard_type, durationLeft: event.duration };
                    addCommsLog('SCIENCE', `Warning: Entering ${event.message}.`);
                    updateHazardUI();
                    break;
                case 'end_mission':
                    stopAllSounds();
                    bridgeUI.className = "flex items-center justify-center p-4";
                    bridgeUI.innerHTML = `<div class="panel p-8 text-center max-w-lg"><h1 class="font-orbitron text-5xl text-cyan-300 mb-4">${event.title}</h1><p class="text-xl text-slate-300">${event.message}</p></div>`;
                    advance = false;
                    break;
            }
            if (advance) { gameState.eventIndex++; processNextEvent(); }
        }
        
        function gameLoop() {
            if (gameState.isPaused) return;
            if(gameState.enemies.length > 0) {
                gameState.enemies.forEach(enemy => {
                    if (Math.random() < 0.33) {
                        addCommsLog('SYSTEM', `Incoming fire from ${enemy.name}!`); takeDamage(5);
                    }
                });
            }
            if(gameState.currentHazard) {
                gameState.currentHazard.durationLeft -= 3000;
                if(gameState.currentHazard.type === 'asteroid_field' && gameState.ship.shields < 50) {
                    addCommsLog('SYSTEM', 'Hull impacted by asteroid debris!'); takeDamage(3);
                }
                if(gameState.currentHazard.durationLeft <= 0) {
                    addCommsLog('SCIENCE', `Hazardous area cleared.`);
                    gameState.currentHazard = null;
                    updateHazardUI();
                }
            }
        }

        function takeDamage(amount) {
            playSound('placeholder/shield_hit.mp3');
            let evasion = gameState.ship.systems.engines === 'operational' ? gameState.ship.powerEffects.evasionChance : 0;
            if (Math.random() * 100 < evasion) { addCommsLog('SYSTEM', 'Enemy fire evaded!'); return; }
            viewscreen.classList.add('damage-flash');
            setTimeout(() => viewscreen.classList.remove('damage-flash'), 300);
            const damageToShields = Math.min(gameState.ship.shields, amount);
            gameState.ship.shields -= damageToShields;
            const remainingDamage = amount - damageToShields;
            if (remainingDamage > 0) gameState.ship.hull -= remainingDamage;
            updateShipStatusUI();
            if (gameState.ship.hull <= 0) {
                stopAllSounds();
                playSound('placeholder/ship_explosion.mp3');
                bridgeUI.innerHTML = `<div class="panel p-8 text-center max-w-lg"><h1 class="text-5xl font-bold text-red-500 mb-4">Ship Destroyed</h1><p class="text-xl text-gray-300">Mission failed.</p></div>`;
                bridgeUI.className = "flex items-center justify-center p-4";
            }
        }
        
        function regenerateShields() { /* ... No sound needed here ... */ }
        
        function addCommsLog(speaker, message) {
            playSound('placeholder/comms_alert.mp3');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="font-bold text-cyan-300">${speaker}: </span><span>${message}</span>`;
            commsLog.appendChild(logEntry); commsLog.scrollTop = commsLog.scrollHeight;
        }

        function updateShipStatusUI() { /* ... No changes ... */ }
        function updateTargetsUI() { /* ... No changes ... */ }
        function updateScienceUI() { /* ... No changes ... */ }
        function updateEngineeringUI() { /* ... No changes ... */ }
        function updateObjectiveUI() { /* ... No changes ... */ }
        function updateHazardUI() { /* ... No changes ... */ }

        firePhasersBtn.addEventListener('click', () => {
            const target = gameState.enemies.find(e => e.id === gameState.ship.targetId);
            if (target) {
                playSound('placeholder/phaser_fire.mp3');
                let damage = 2.5; if (target.isScanned && target.weakness === 'phasers') damage *= 2;
                target.hull = Math.max(0, target.hull - damage);
                addCommsLog('WEAPONS', `Phasers fired at ${target.name}.`);
                document.getElementById(target.id)?.animate([{ opacity: 0.5 }, { opacity: 1 }], { duration: 200, iterations: 2 });
                handleWeaponCooldown(firePhasersBtn, gameState.ship.weapons.phasers, 'Fire Phasers');
                checkEnemyDefeat(target);
            }
        });

        fireTorpedoesBtn.addEventListener('click', () => {
            const target = gameState.enemies.find(e => e.id === gameState.ship.targetId);
            if (target) {
                playSound('placeholder/torpedo_launch.mp3');
                let damage = 20; if (target.isScanned && target.weakness === 'torpedoes') damage *= 2;
                target.hull = Math.max(0, target.hull - damage);
                gameState.ship.weapons.torpedoes.count--; addCommsLog('WEAPONS', `Torpedo launched at ${target.name}.`);
                handleWeaponCooldown(fireTorpedoesBtn, gameState.ship.weapons.torpedoes, `Fire Torpedoes (${gameState.ship.weapons.torpedoes.count})`);
                checkEnemyDefeat(target);
            }
        });
        
        function handleWeaponCooldown(button, weapon, originalText) { /* ... No changes ... */ }

        function checkEnemyDefeat(enemy) {
            updateScienceUI();
            if (enemy.hull <= 0) {
                playSound('placeholder/enemy_explosion.mp3');
                addCommsLog('SYSTEM', `${enemy.name} has been destroyed.`);
                gameState.enemies = gameState.enemies.filter(e => e.id !== enemy.id);
                if (gameState.ship.targetId === enemy.id) gameState.ship.targetId = null;
                document.getElementById(enemy.id)?.remove();
                updateTargetsUI(); updateScienceUI();
            }
        }
        
        // --- Power Management, Visuals, and other helpers ---
        [shieldsSlider, enginesSlider, weaponsSlider].forEach(slider => { /* ... No changes ... */ });
        function distributePower(changedSlider) { /* ... Omitted for brevity ... */ }
        function updatePowerUI() { /* ... Omitted for brevity ... */ }
        function createStarfield() { /* ... Omitted for brevity ... */ }
        function spawnEnemyOnViewscreen(enemy) { /* ... Omitted for brevity ... */ }
        function displayChoice(event) { /* ... Omitted for brevity ... */ }
        function scanTarget(target) { /* ... Omitted for brevity ... */ }
        function analyzeAnomaly(event) { /* ... Omitted for brevity ... */ }
        function displayAnomaly(event) { /* ... Omitted for brevity ... */ }
    </script>
</body>
</html>

